<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="postgres," />










<meta name="description" content="主要记录本人平时使用的postgres的建库，备库和日常使用的SQL语句，其中涉及一点postgres的高可用运维内容和数据库的注意事项。">
<meta name="keywords" content="postgres">
<meta property="og:type" content="article">
<meta property="og:title" content="postgres日常使用">
<meta property="og:url" content="http://yoursite.com/2018/05/31/postgressql/index.html">
<meta property="og:site_name" content="日出东方">
<meta property="og:description" content="主要记录本人平时使用的postgres的建库，备库和日常使用的SQL语句，其中涉及一点postgres的高可用运维内容和数据库的注意事项。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-03-02T08:46:36.222Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="postgres日常使用">
<meta name="twitter:description" content="主要记录本人平时使用的postgres的建库，备库和日常使用的SQL语句，其中涉及一点postgres的高可用运维内容和数据库的注意事项。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/05/31/postgressql/"/>





  <title>postgres日常使用 | 日出东方</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">日出东方</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ZHD's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-comment"></i> <br />
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/31/postgressql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZHD">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="日出东方">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">postgres日常使用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-31T21:43:35+08:00">
                2018-05-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgres/" itemprop="url" rel="index">
                    <span itemprop="name">postgres</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,936
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <div class="note warning"><p>主要记录本人平时使用的postgres的建库，备库和日常使用的SQL语句，其中涉及一点postgres的高可用运维内容和数据库的注意事项。</p></div>
<a id="more"></a>
<h5 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export PGHOME=/db/pgSQL</span><br><span class="line">export PGDATA=/db/dbc1</span><br><span class="line">export LD_LIBRARY_PATH=$PGHOME/lib</span><br><span class="line">export PATH=$PGHOME/bin:$PATH</span><br><span class="line">export PGDATABASE=atlas</span><br></pre></td></tr></table></figure>
<h5 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">test</span> <span class="keyword">WITH</span> OWNER = postgres <span class="keyword">ENCODING</span> = <span class="string">'UTF8'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span>  <span class="keyword">user</span> corp_channel <span class="keyword">with</span> <span class="keyword">password</span> <span class="string">'corp_channel'</span>; <span class="comment">-- 创建用户密码</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> corp_channel owner  corp_channel; <span class="comment">---创建用户</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> corp_channel owner <span class="keyword">to</span> corp_channel;(修改数据库owner)</span><br><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> <span class="keyword">database</span> corp_channel <span class="keyword">to</span> corp_channel; <span class="comment">---将corp_channel数据库的所有权限赋予corp_channel用户</span></span><br><span class="line"> 查看表的权限 <span class="comment">--- \z table</span></span><br></pre></td></tr></table></figure>
<h5 id="清除所有表"><a href="#清除所有表" class="headerlink" title="清除所有表"></a>清除所有表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> $$</span><br><span class="line">	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">if</span>( to_regclass(<span class="string">'tablename'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> ) <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">if</span>( (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> pathman_config <span class="keyword">where</span> partrel = <span class="string">'tablename'</span>::regclass) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>) <span class="keyword">then</span></span><br><span class="line">				PERFORM drop_partitions(<span class="string">'tablename'</span>::regclass,<span class="literal">true</span>);</span><br><span class="line">			<span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">			<span class="keyword">drop</span> <span class="keyword">table</span> tablename;</span><br><span class="line">		<span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">	<span class="keyword">end</span>;</span><br><span class="line">$$;</span><br></pre></td></tr></table></figure>
<h5 id="查看表的索引："><a href="#查看表的索引：" class="headerlink" title="查看表的索引："></a>查看表的索引：</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pg_indexes <span class="keyword">where</span> tablename=<span class="string">'log'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="导出备份数据库："><a href="#导出备份数据库：" class="headerlink" title="导出备份数据库："></a>导出备份数据库：</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -h localhost -U postgres databasename &gt; /tmp/databasename.bak.yyyymmdd.sql</span><br></pre></td></tr></table></figure>
<h5 id="导入恢复数据库-sql文件是pg-dump导出的文件就行，可以是整个数据库，也可以只是单个表，也可以只是结构等"><a href="#导入恢复数据库-sql文件是pg-dump导出的文件就行，可以是整个数据库，也可以只是单个表，也可以只是结构等" class="headerlink" title="导入恢复数据库(sql文件是pg_dump导出的文件就行，可以是整个数据库，也可以只是单个表，也可以只是结构等)"></a>导入恢复数据库(sql文件是pg_dump导出的文件就行，可以是整个数据库，也可以只是单个表，也可以只是结构等)</h5><figure class="highlight"><figcaption><span>lite</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -h localhost -U postgres -d databasename &lt; /tmp/databasename.bak.yyyymmdd.sql</span><br></pre></td></tr></table></figure>
<h5 id="导出数据结构，主要是加上参数-s："><a href="#导出数据结构，主要是加上参数-s：" class="headerlink" title="导出数据结构，主要是加上参数-s："></a>导出数据结构，主要是加上参数-s：</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -U username -W dbname -f /tmp/filename.sql</span><br></pre></td></tr></table></figure>
<h5 id="导出某个表："><a href="#导出某个表：" class="headerlink" title="导出某个表："></a>导出某个表：</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -h localhost -U postgres -t tablename dbname &gt; test.sql</span><br></pre></td></tr></table></figure>
<h5 id="导出某个表的结构，同样是加参数”-s”："><a href="#导出某个表的结构，同样是加参数”-s”：" class="headerlink" title="导出某个表的结构，同样是加参数”-s”："></a>导出某个表的结构，同样是加参数”-s”：</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -h localhost -U postgres -t tablename -s dbname &gt; test_construct.sql</span><br></pre></td></tr></table></figure>
<h5 id="导出某个表的数据，加参数”-a”："><a href="#导出某个表的数据，加参数”-a”：" class="headerlink" title="导出某个表的数据，加参数”-a”："></a>导出某个表的数据，加参数”-a”：</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump -h localhost -U postgres -t tablename -a dbname &gt; test_data.sql</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查看序列：<span class="keyword">select</span> * <span class="keyword">from</span> information_schema.sequences <span class="keyword">where</span> sequence_schema = <span class="string">'public'</span>;</span><br><span class="line">查看数据库大小：<span class="keyword">select</span> pg_size_pretty(pg_database_size(<span class="string">'test'</span>));</span><br><span class="line">查看表的大小：<span class="keyword">select</span> pg_size_pretty(pg_relation_size(<span class="string">'test'</span>));</span><br></pre></td></tr></table></figure>
<h5 id="由于-copy-命令始终是到数据库服务端找文件，当以文件形式导入导出数据时需以超级用户执行，权限要求很高，适合数据库管理员操作-而-copy-命令可在客户端执行导入客户端的数据文件，权限要求没那么高，适合开发人员，测试人员使用，因为生产库的权限掌握在-DBA-手中。"><a href="#由于-copy-命令始终是到数据库服务端找文件，当以文件形式导入导出数据时需以超级用户执行，权限要求很高，适合数据库管理员操作-而-copy-命令可在客户端执行导入客户端的数据文件，权限要求没那么高，适合开发人员，测试人员使用，因为生产库的权限掌握在-DBA-手中。" class="headerlink" title="由于 copy 命令始终是到数据库服务端找文件，当以文件形式导入导出数据时需以超级用户执行，权限要求很高，适合数据库管理员操作;而 \copy 命令可在客户端执行导入客户端的数据文件，权限要求没那么高，适合开发人员，测试人员使用，因为生产库的权限掌握在 DBA 手中。"></a>由于 copy 命令始终是到数据库服务端找文件，当以文件形式导入导出数据时需以超级用户执行，权限要求很高，适合数据库管理员操作;而 \copy 命令可在客户端执行导入客户端的数据文件，权限要求没那么高，适合开发人员，测试人员使用，因为生产库的权限掌握在 DBA 手中。</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">copy (<span class="keyword">select</span> * <span class="keyword">from</span> tablename) <span class="keyword">to</span> <span class="string">'/tmp/1.txt'</span> (<span class="keyword">format</span> csv,delimiter <span class="string">'|'</span>);</span><br><span class="line">\copy (<span class="keyword">select</span> * <span class="keyword">from</span> tablename) <span class="keyword">to</span> <span class="string">'/tmp/1.txt'</span> <span class="keyword">with</span> delimiter <span class="string">'|'</span>;</span><br><span class="line">\copy table 	 from '/tmp/1.txt' with delimiter '|';</span><br><span class="line"></span><br><span class="line">psql -c "\copy (<span class="keyword">select</span> * <span class="keyword">from</span> PBX_CASH_RCV_REG <span class="keyword">where</span> TRAN_DATE=<span class="string">'20170913'</span>) <span class="keyword">to</span> <span class="string">'PBX_CASH_RCV_REG.txt'</span> <span class="keyword">with</span> delimiter <span class="string">'|'</span> <span class="literal">NULL</span> <span class="string">' '</span><span class="string">"</span></span><br></pre></td></tr></table></figure>
<h5 id="清除所有表-1"><a href="#清除所有表-1" class="headerlink" title="清除所有表"></a>清除所有表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> aaa() <span class="keyword">RETURNS</span> <span class="built_in">void</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">    tmp <span class="built_in">VARCHAR</span>(<span class="number">512</span>);</span><br><span class="line"><span class="keyword">DECLARE</span> <span class="keyword">names</span> <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> </span><br><span class="line">    <span class="keyword">select</span> tablename <span class="keyword">from</span> pg_tables <span class="keyword">where</span> schemaname=<span class="string">'public'</span> ;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">FOR</span> stmt <span class="keyword">IN</span> <span class="keyword">names</span> <span class="keyword">LOOP</span></span><br><span class="line">    tmp := <span class="string">'DROP TABLE '</span>|| quote_ident(stmt.tablename) || <span class="string">' CASCADE;'</span>;</span><br><span class="line">RAISE NOTICE 'notice: %', tmp;</span><br><span class="line">    <span class="keyword">EXECUTE</span> <span class="string">'DROP TABLE '</span>|| quote_ident(stmt.tablename) || <span class="string">' CASCADE;'</span>;</span><br><span class="line">  <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">  RAISE NOTICE 'finished .....';</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ LANGUAGE plpgsql;</span><br><span class="line"></span><br><span class="line">调用时用：</span><br><span class="line"><span class="keyword">select</span> aaa();</span><br></pre></td></tr></table></figure>
<h5 id="获取系统表中字段信息"><a href="#获取系统表中字段信息" class="headerlink" title="获取系统表中字段信息"></a>获取系统表中字段信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.attnum,a.attname <span class="keyword">AS</span> <span class="keyword">field</span>,t.typname <span class="keyword">AS</span> <span class="keyword">type</span>,a.attlen <span class="keyword">AS</span> <span class="keyword">length</span>,a.atttypmod <span class="keyword">AS</span> lengthvar,a.attnotnull <span class="keyword">AS</span> notnull <span class="keyword">FROM</span> pg_class c,pg_attribute a,pg_type t</span><br><span class="line"><span class="keyword">WHERE</span> c.relname = <span class="string">'dbmanager_hostlist'</span> <span class="keyword">and</span> a.attnum &gt; <span class="number">0</span> <span class="keyword">and</span> a.attrelid = c.oid <span class="keyword">and</span> a.atttypid = t.oid <span class="keyword">ORDER</span> <span class="keyword">BY</span> a.attnum;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\dtS   <span class="comment">--- 查看系统表</span></span><br><span class="line">\dtS+  <span class="comment">---  查看详细信息</span></span><br><span class="line"><span class="keyword">comment</span> <span class="keyword">on</span> <span class="keyword">table</span> t <span class="keyword">IS</span> <span class="string">'this is a test'</span>; <span class="comment">--- 添加表注释</span></span><br><span class="line">\<span class="keyword">set</span> AUTOCOMMIT <span class="keyword">off</span> <span class="comment">--- 关闭自动更新</span></span><br></pre></td></tr></table></figure>
<h5 id="指定去重的列排序"><a href="#指定去重的列排序" class="headerlink" title="指定去重的列排序"></a>指定去重的列排序</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">on</span> (subject) <span class="keyword">id</span>,<span class="keyword">name</span>,subject,score <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">order</span> <span class="keyword">by</span> subject,score <span class="keyword">desc</span>;</span><br><span class="line">扫描10行</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">limit</span> <span class="number">1</span> <span class="keyword">offset</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<h5 id="创建序列"><a href="#创建序列" class="headerlink" title="创建序列"></a>创建序列</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">sequence</span> seq</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">nextval</span>(<span class="string">'seq'</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">nextval</span>(<span class="string">'seq'</span>) <span class="keyword">from</span> window_test;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">function</span> <span class="keyword">nextval</span>(regclass) volatile; <span class="comment">-- 只执行一遍 </span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">function</span> <span class="keyword">nextval</span>(regclass) stable; </span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> generate_series(<span class="number">1</span>,<span class="number">30</span>) <span class="keyword">as</span> g(i) <span class="keyword">where</span> i = <span class="keyword">nextval</span>(<span class="string">'seq'</span>::regclass);</span><br></pre></td></tr></table></figure>
<h5 id="锁表问题"><a href="#锁表问题" class="headerlink" title="锁表问题"></a>锁表问题</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查询是否锁表了                                       </span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">oid</span> <span class="keyword">from</span> pg_class <span class="keyword">where</span> relname=<span class="string">'可能锁表了的表'</span></span><br><span class="line"><span class="keyword">select</span> pid <span class="keyword">from</span> pg_locks <span class="keyword">where</span> relation=<span class="string">'上面查出的oid'</span></span><br><span class="line"><span class="comment">--如果查询到了结果，表示该表被锁 则需要释放锁定        </span></span><br><span class="line"><span class="keyword">select</span> pg_cancel_backend(上面查到的pid) </span><br><span class="line"><span class="keyword">select</span> pg_terminate_backend(上面查到pid);</span><br></pre></td></tr></table></figure>
<h5 id="增删改查的操作"><a href="#增删改查的操作" class="headerlink" title="增删改查的操作"></a>增删改查的操作</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- 修改字段名</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> ubb_model <span class="keyword">rename</span> <span class="keyword">column</span> hostname <span class="keyword">to</span> hostgroup;</span><br><span class="line"><span class="comment">--- 删除唯一约束</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> ubb_services <span class="keyword">drop</span> <span class="keyword">constraint</span> ubb_services_services_key;</span><br><span class="line"><span class="comment">--- 增加一列</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span> column_name datatype;                   </span><br><span class="line"><span class="comment">--- 删除一列</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">DROP</span>  column_name;                           </span><br><span class="line"><span class="comment">--- 更改列的数据类型</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ALTER</span>  column_name <span class="keyword">TYPE</span> datatype;              </span><br><span class="line"><span class="comment">--- 表的重命名</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">RENAME</span> <span class="keyword">TO</span> new_name;                           </span><br><span class="line"><span class="comment">--- 更改列的名字</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">RENAME</span> column_name <span class="keyword">to</span> new_column_name;          </span><br><span class="line"><span class="comment">--- 字段的not null设置</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ALTER</span> column_name &#123;<span class="keyword">SET</span>|<span class="keyword">DROP</span>&#125; <span class="keyword">NOT</span> <span class="literal">NULL</span>;          </span><br><span class="line"><span class="comment">--- 给列添加default</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ALTER</span> column_name <span class="keyword">SET</span> <span class="keyword">DEFAULT</span> expression;</span><br><span class="line"><span class="comment">--- 添加主键</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> goods <span class="keyword">add</span> primary <span class="keyword">key</span>(<span class="keyword">sid</span>);</span><br><span class="line"><span class="comment">--- 添加外键</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> orders <span class="keyword">add</span> foreign <span class="keyword">key</span>(goods_id) <span class="keyword">references</span> goods(<span class="keyword">sid</span>)  <span class="keyword">on</span> <span class="keyword">update</span> <span class="keyword">cascade</span> <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>;</span><br><span class="line">on <span class="keyword">update</span> <span class="keyword">cascade</span>: <span class="comment">--- 被引用行更新时，引用行自动更新； </span></span><br><span class="line"><span class="keyword">on</span> <span class="keyword">update</span> restrict: <span class="comment">--- 被引用的行禁止更新；</span></span><br><span class="line"><span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">cascade</span>: <span class="comment">--- 被引用行删除时，引用行也一起删除；</span></span><br><span class="line"><span class="keyword">on</span> <span class="keyword">delete</span> restrict: <span class="comment">--- 被引用的行禁止删除；</span></span><br><span class="line"><span class="comment">--- 删除外键</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> orders <span class="keyword">drop</span> <span class="keyword">constraint</span> orders_goods_id_fkey;</span><br><span class="line"><span class="comment">--- 添加唯一约束</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> goods <span class="keyword">add</span> <span class="keyword">constraint</span> unique_goods_sid <span class="keyword">unique</span>(<span class="keyword">sid</span>);</span><br><span class="line"><span class="comment">--- 删除默认值</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> goods  <span class="keyword">alter</span> <span class="keyword">column</span> <span class="keyword">sid</span> <span class="keyword">drop</span> <span class="keyword">default</span>;</span><br><span class="line"><span class="comment">---  修改字段的数据类型</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> goods <span class="keyword">alter</span> <span class="keyword">column</span> <span class="keyword">sid</span> <span class="keyword">type</span> <span class="built_in">character</span> <span class="built_in">varying</span>;</span><br><span class="line"><span class="comment">--- 重命名字段</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> goods <span class="keyword">rename</span> <span class="keyword">column</span> <span class="keyword">sid</span> <span class="keyword">to</span> ssid;</span><br></pre></td></tr></table></figure>
<h5 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">单列索引</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column_name);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> salary_index <span class="keyword">ON</span> COMPANY (salary); <span class="comment">-- 例子</span></span><br><span class="line">组合索引</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (column1_name, column2_name);</span><br><span class="line">唯一索引</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">on</span> table_name (column_name);</span><br><span class="line">局部索引</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> index_name</span><br><span class="line"><span class="keyword">on</span> table_name (conditional_expression);</span><br><span class="line">删除索引</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> index_name;</span><br></pre></td></tr></table></figure>
<h5 id="时间的使用方法"><a href="#时间的使用方法" class="headerlink" title="时间的使用方法:"></a>时间的使用方法:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">select  to_char(CURRENT_DATE,&apos;YYYYMMDD&apos;);</span><br><span class="line">select  to_char(CURRENT_TIMESTAMP,&apos;YYYYMMDD&apos;);</span><br><span class="line">select  to_char(CURRENT_TIMESTAMP,&apos;YYYYMMDDMSUS&apos;);	</span><br><span class="line">select  to_char(CURRENT_TIMESTAMP,&apos;HH24MISS&apos;);</span><br><span class="line">select  to_char(number,&apos;00000000&apos;)</span><br><span class="line">--- 时间的计算</span><br><span class="line">select CURRENT_DATE  + integer &apos;7&apos;;</span><br><span class="line">select CURRENT_TIME  + interval &apos;1 hour&apos;;</span><br><span class="line">select CURRENT_TIME  + time &apos;03:00&apos;;</span><br></pre></td></tr></table></figure>
<p>####类型转化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--- numeric转化为字符串</span><br><span class="line">select cast(transamt as varchar) from ol_transdetail where cast(transamt as varchar) like &apos;%.50&apos;;</span><br></pre></td></tr></table></figure>
<h5 id="如何找到postgreSQL数据库中占空间最大的表？"><a href="#如何找到postgreSQL数据库中占空间最大的表？" class="headerlink" title="如何找到postgreSQL数据库中占空间最大的表？"></a>如何找到postgreSQL数据库中占空间最大的表？</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">SELECT</span> relname,relpages <span class="keyword">FROM</span> pg_class <span class="keyword">ORDER</span> <span class="keyword">BY</span> relpages <span class="keyword">DESC</span>;</span><br><span class="line">如果你只想要最大的那个表，可以用limit参数来限制结果的数量，就像这样：</span><br><span class="line"><span class="keyword">SELECT</span> relname, relpages <span class="keyword">FROM</span> pg_class <span class="keyword">ORDER</span> <span class="keyword">BY</span> relpages <span class="keyword">DESC</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">1.relname - 关系名/表名</span><br><span class="line">2.relpages - 关系页数（默认情况下一个页大小是8kb）</span><br><span class="line">3.pg_class - 系统表, 维护着所有relations的详细信息</span><br><span class="line">4.limit 1 - 限制返回结果只显示一行</span><br></pre></td></tr></table></figure>
<h5 id="如何计算postgreSQL数据库所占用的硬盘大小？"><a href="#如何计算postgreSQL数据库所占用的硬盘大小？" class="headerlink" title="如何计算postgreSQL数据库所占用的硬盘大小？"></a>如何计算postgreSQL数据库所占用的硬盘大小？</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pg_database_size 这个方法是专门用来查询数据库大小的，它返回的结果单位是字节（bytes）。:</span><br><span class="line"><span class="keyword">SELECT</span> pg_database_size(<span class="string">'geekdb'</span>);</span><br><span class="line">如果你想要让结果更直观一点，那就使用pg_size_pretty方法，它可以把字节数转换成更友好易读的格式。</span><br><span class="line"><span class="keyword">SELECT</span> pg_size_pretty(pg_database_size(<span class="string">'geekdb'</span>));</span><br></pre></td></tr></table></figure>
<h5 id="如何计算postgreSQL表所占用的硬盘大小？"><a href="#如何计算postgreSQL表所占用的硬盘大小？" class="headerlink" title="如何计算postgreSQL表所占用的硬盘大小？"></a>如何计算postgreSQL表所占用的硬盘大小？</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下面这个命令查出来的表大小是包含索引和toasted data的，如果你对除去索引外仅仅是表占的大小感兴趣，可以 使用后面提供的那个命令。</span><br><span class="line"><span class="keyword">SELECT</span> pg_size_pretty(pg_total_relation_size(<span class="string">'big_table'</span>));</span><br></pre></td></tr></table></figure>
<h5 id="类别一、-如果两张张表（导出表和目标表）的字段一致，并且希望插入全部数据，可以用这种方法："><a href="#类别一、-如果两张张表（导出表和目标表）的字段一致，并且希望插入全部数据，可以用这种方法：" class="headerlink" title="类别一、 如果两张张表（导出表和目标表）的字段一致，并且希望插入全部数据，可以用这种方法："></a>类别一、 如果两张张表（导出表和目标表）的字段一致，并且希望插入全部数据，可以用这种方法：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO  目标表  SELECT  * FROM  来源表 ;</span><br></pre></td></tr></table></figure>
<h5 id="要将-articles-表插入到-newArticles-表中，则可以通过如下SQL语句实现："><a href="#要将-articles-表插入到-newArticles-表中，则可以通过如下SQL语句实现：" class="headerlink" title="要将 articles 表插入到 newArticles 表中，则可以通过如下SQL语句实现："></a>要将 articles 表插入到 newArticles 表中，则可以通过如下SQL语句实现：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO  newArticles  SELECT  * FROM  articles ;</span><br></pre></td></tr></table></figure>
<h5 id="如果只希望导入指定字段，可以用这种方法："><a href="#如果只希望导入指定字段，可以用这种方法：" class="headerlink" title="如果只希望导入指定字段，可以用这种方法："></a>如果只希望导入指定字段，可以用这种方法：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO  目标表 (字段1, 字段2, ...)  SELECT   字段1, 字段2, ...   FROM  来源表 ;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> TPersonnelChange(  </span><br><span class="line">    UserId,  </span><br><span class="line">    DepId,  </span><br><span class="line">    SubDepId,  </span><br><span class="line">    PostionType,  </span><br><span class="line">    AuthorityId,  </span><br><span class="line">    ChangeDateS,  </span><br><span class="line">    InsertDate,  </span><br><span class="line">    UpdateDate,  </span><br><span class="line">    SakuseiSyaId  </span><br><span class="line">)<span class="keyword">SELECT</span>  </span><br><span class="line">    UserId,  </span><br><span class="line">    DepId,  </span><br><span class="line">    SubDepId,  </span><br><span class="line">    PostionType,  </span><br><span class="line">    AuthorityId,  </span><br><span class="line">    <span class="keyword">DATE_FORMAT</span>(EmployDate, <span class="string">'%Y%m%d'</span>),  </span><br><span class="line">    <span class="keyword">NOW</span>(),  </span><br><span class="line">    <span class="keyword">NOW</span>(),  </span><br><span class="line">    <span class="number">1</span>  </span><br><span class="line"><span class="keyword">FROM</span>  </span><br><span class="line">    TUserMst  </span><br><span class="line"><span class="keyword">WHERE</span>  </span><br><span class="line">    <span class="string">`Status`</span> = <span class="number">0</span>  </span><br><span class="line"><span class="keyword">AND</span> QuitFlg = <span class="number">0</span>  </span><br><span class="line"><span class="keyword">AND</span> UserId &gt; <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h5 id="generate-series函数应用"><a href="#generate-series函数应用" class="headerlink" title="generate_series函数应用"></a><a href="http://www.cnblogs.com/mchina/archive/2013/04/03/2997722.html" target="_blank" rel="noopener">generate_series函数应用</a></h5><h5 id="批量添加数据"><a href="#批量添加数据" class="headerlink" title="批量添加数据"></a>批量添加数据</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> generate_series(<span class="number">1</span>, <span class="number">10</span>); <span class="comment">--- int</span></span><br><span class="line"><span class="keyword">select</span> generate_series(<span class="number">1</span>, <span class="number">10</span>, <span class="number">3</span>); <span class="comment">--- 如果step 是正数，而start 大于stop，那么返回零行。相反，如果step 是负数，start 小于stop，则返回零行。如果是NULL 输入，也产生零行。step 为零则是一个错误。</span></span><br><span class="line"><span class="keyword">select</span> generate_series(<span class="number">5</span>,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">select</span> generate_series(<span class="keyword">now</span>(), <span class="keyword">now</span>() + <span class="string">'7 days'</span>, <span class="string">'1 day'</span>);</span><br><span class="line"><span class="keyword">select</span> generate_series(<span class="keyword">to_date</span>(<span class="string">'20130403'</span>,<span class="string">'yyyymmdd'</span>), <span class="keyword">to_date</span>(<span class="string">'20130404'</span>,<span class="string">'yyyymmdd'</span>), <span class="string">'3 hours'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="锁的问题"><a href="#锁的问题" class="headerlink" title="锁的问题"></a>锁的问题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.如何锁一个表的某一行</span><br><span class="line">select * from table rowlock where id =1</span><br></pre></td></tr></table></figure>
<h4 id="常用语句"><a href="#常用语句" class="headerlink" title="常用语句"></a>常用语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> localdatetime,retcode,respinfo <span class="keyword">from</span>  ol_transdetail <span class="keyword">where</span> localdatetime&gt; <span class="string">'20180109100000'</span> <span class="keyword">and</span> receprodcode=<span class="string">'612020'</span> <span class="keyword">and</span> retcode=<span class="string">'09209999'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ol_transdetail <span class="keyword">where</span>  localdatetime&gt;<span class="string">'20180109163000'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">SUBSTR</span>(localdatetime,<span class="number">9</span>,<span class="number">4</span>),logip,retcode,<span class="keyword">count</span>(*),<span class="keyword">round</span>(<span class="keyword">avg</span>(protime),<span class="number">2</span>) <span class="keyword">as</span> 渠道耗时,<span class="keyword">round</span>(<span class="keyword">avg</span>(backtime),<span class="number">2</span>) <span class="keyword">as</span> 后台耗时 <span class="keyword">from</span> ol_transdetail <span class="keyword">where</span> localdate =<span class="string">'20180329'</span>  <span class="keyword">and</span> localdatetime &gt; <span class="string">'20180329170300'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">SUBSTR</span>(localdatetime,<span class="number">9</span>,<span class="number">4</span>),logip,retcode <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">SUBSTR</span>(localdatetime,<span class="number">9</span>,<span class="number">4</span>);</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">select</span> <span class="keyword">DISTINCT</span>(logip) <span class="keyword">from</span> ol_transdetail  ;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">select</span> logip,retcode,<span class="keyword">count</span>(*),<span class="keyword">round</span>(<span class="keyword">avg</span>(protime),<span class="number">2</span>) <span class="keyword">as</span> 渠道耗时,<span class="keyword">round</span>(<span class="keyword">avg</span>(backtime),<span class="number">2</span>) <span class="keyword">as</span> 后台耗时  <span class="keyword">from</span> ol_transdetail <span class="keyword">where</span> localdatetime &gt;= to_char(<span class="keyword">now</span>() - <span class="built_in">interval</span> <span class="string">'1 min'</span>,<span class="string">'YYYYMMDDHHMMSS'</span>) <span class="keyword">group</span> <span class="keyword">by</span>  logip ,retcode;</span><br></pre></td></tr></table></figure>
<h4 id="每分钟查询结果"><a href="#每分钟查询结果" class="headerlink" title="每分钟查询结果"></a>每分钟查询结果</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">SUBSTR</span>(localdatetime,<span class="number">9</span>,<span class="number">4</span>),logip,retcode,<span class="keyword">count</span>(*),<span class="keyword">round</span>(<span class="keyword">avg</span>(protime),<span class="number">2</span>) <span class="keyword">as</span> 渠道耗时,<span class="keyword">round</span>(<span class="keyword">avg</span>(backtime),<span class="number">2</span>) <span class="keyword">as</span> 后台耗时 <span class="keyword">from</span> ol_transdetail <span class="keyword">where</span>  localdatetime &gt; to_char(<span class="keyword">now</span>() - <span class="built_in">interval</span> <span class="string">'1 min'</span>,<span class="string">'YYYYMMDDHHMISS'</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">SUBSTR</span>(localdatetime,<span class="number">9</span>,<span class="number">4</span>),logip,retcode <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">SUBSTR</span>(localdatetime,<span class="number">9</span>,<span class="number">4</span>),渠道耗时 <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="创建基础备份"><a href="#创建基础备份" class="headerlink" title="创建基础备份"></a>创建基础备份</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	vi pg_hba.conf</span><br><span class="line">	host all all  192.168.67.35/24             md5</span><br><span class="line">	host replication postgres 192.168.67.35/24 trust</span><br><span class="line">	pg_basebackup -h node1 -U replication -D /data/postgresql/data/ -X stream -P</span><br><span class="line">查看主备关系</span><br><span class="line">	<span class="keyword">select</span> * <span class="keyword">from</span> pg_stat_replication ;</span><br></pre></td></tr></table></figure>
<h3 id="用pg-rewind命令同步新备库"><a href="#用pg-rewind命令同步新备库" class="headerlink" title="用pg_rewind命令同步新备库"></a>用pg_rewind命令同步新备库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pg_rewind --target-pgdata $PGDATA --source-server=&apos;host=192.168.1.203 port=5432 user=postgres dbname=postgres&apos; -P</span><br><span class="line">mv recovery.done recovery.conf</span><br><span class="line">vi recovery.conf</span><br></pre></td></tr></table></figure>
<h3 id="高可用（pcs-corosync-postgres）修复旧Master"><a href="#高可用（pcs-corosync-postgres）修复旧Master" class="headerlink" title="高可用（pcs+corosync+postgres）修复旧Master"></a>高可用（pcs+corosync+postgres）修复旧Master</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">检查集群状态   </span><br><span class="line">由于设置了migration-threshold=&quot;3&quot;，发生一次普通的错误，Pacemaker会在原地重新启动postgres进程，不发生主从切换。</span><br><span class="line">（如果Master的物理机或网络发生故障，直接进行failover。）</span><br></pre></td></tr></table></figure>
<p>第一种方法：可通过<code>pg_basebackup</code>修复旧Master（需要强行恢复的情况下）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># su - postgres</span><br><span class="line">$ rm -rf /data/postgresql/data</span><br><span class="line">$ pg_basebackup -h 192.168.41.136 -U postgres -D /data/postgresql/data -X stream -P</span><br><span class="line">$ exit</span><br><span class="line"># pcs resource cleanup msPostgresql</span><br></pre></td></tr></table></figure>
<p>第二种方法：通过<code>pg_baseback</code>修复旧Master。<code>cls_rebuild_slave</code>是对<code>pg_basebackup</code>的包装，主要多了执行结果状态的检查。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 pha4pgsql]# rm -rf /data/postgresql/data</span><br><span class="line">[root@node1 pha4pgsql]# cls_rebuild_slave </span><br><span class="line">22636/22636 kB (100%), 1/1 tablespace</span><br><span class="line">All resources/stonith devices successfully cleaned up</span><br><span class="line">wait for recovery complete</span><br><span class="line">.....</span><br><span class="line">slave recovery of node1 successed</span><br><span class="line">[root@node1 pha4pgsql]# cls_status</span><br><span class="line">Last updated: Fri Apr 22 02:40:48 2016</span><br><span class="line">Last change: Fri Apr 22 02:40:36 2016 by root via crm_resource on node1</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: node2 (2) - partition with quorum</span><br><span class="line">Version: 1.1.12-a14efad</span><br><span class="line">2 Nodes configured</span><br><span class="line">4 Resources configured</span><br></pre></td></tr></table></figure>
<p>第三种方法: 9.5以上版本还可以通过<code>pg_rewind</code>修复旧Master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 pha4pgsql]# cls_repair_by_pg_rewind </span><br><span class="line">connected to server</span><br><span class="line">servers diverged at WAL position 0/7000410 on timeline 2</span><br><span class="line">rewinding from last common checkpoint at 0/7000368 on timeline 2</span><br><span class="line">reading source file list</span><br><span class="line">reading target file list</span><br><span class="line">reading WAL in target</span><br><span class="line">need to copy 67 MB (total source directory size is 85 MB)</span><br><span class="line">69591/69591 kB (100%) copied</span><br><span class="line">creating backup label and updating control file</span><br><span class="line">syncing target data directory</span><br><span class="line">Done!</span><br><span class="line">All resources/stonith devices successfully cleaned up</span><br><span class="line">wait for recovery complete</span><br><span class="line">....</span><br><span class="line">slave recovery of node1 successed</span><br></pre></td></tr></table></figure>
<h3 id="高可用（pcs-corosync-postgres）Slave上进程故障"><a href="#高可用（pcs-corosync-postgres）Slave上进程故障" class="headerlink" title="高可用（pcs+corosync+postgres）Slave上进程故障"></a>高可用（pcs+corosync+postgres）Slave上进程故障</h3><p>再强制杀死Master上的postgres进程2次后检查集群状态。</p>
<p>fail-count增加到3后，Pacemaker不再启动PostgreSQL，保持其为停止状态。</p>
<p>同时，Master(node1)(VIP所在的主机)上的复制模式被自动切换到异步复制，防止写操作hang住。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 pha4pgsql]# tail /var/lib/pgsql/tmp/rep_mode.conf</span><br><span class="line">synchronous_standby_names = ''</span><br></pre></td></tr></table></figure>
<h4 id="修复Salve"><a href="#修复Salve" class="headerlink" title="修复Salve"></a>修复Salve</h4><p>在node2上执行<code>cls_cleanup</code>，清除fail-count后，Pacemaker会再次启动PostgreSQL进程。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# cls_cleanup </span><br><span class="line">All resources/stonith devices successfully cleaned up</span><br><span class="line">[root@node2 ~]# cls_status </span><br><span class="line">Last updated: Sun May  8 01:43:13 2016</span><br><span class="line">Last change: Sun May  8 01:43:08 2016 by root via crm_resource on node1</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: node2 (2) - partition with quorum</span><br><span class="line">Version: 1.1.12-a14efad</span><br><span class="line">2 Nodes configured</span><br><span class="line">4 Resources configured</span><br></pre></td></tr></table></figure>
<p>同时，Master(node1)上的复制模式又自动切换回到同步复制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 pha4pgsql]# tail /var/lib/pgsql/tmp/rep_mode.conf</span><br><span class="line">synchronous_standby_names = &apos;node2&apos;(只会有同步流复制)</span><br></pre></td></tr></table></figure>
<h2 id="错误排查"><a href="#错误排查" class="headerlink" title="错误排查"></a>错误排查</h2><p>出现故障时，可通过以下方法排除故障</p>
<ol>
<li><p>确认集群服务是否OK</p>
<p>pcs status</p>
</li>
<li><p>查看错误日志</p>
<p>PostgreSQL的错误日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/log/messages</span><br><span class="line">/var/log/cluster/corosync.log</span><br></pre></td></tr></table></figure>
<p>Pacemaker输出的日志非常多，可以进行过滤。</p>
<p>只看Pacemaker的资源调度（在Current DC节点上执行)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep Initiating /var/log/messages</span><br></pre></td></tr></table></figure>
<p>只查看expgsql RA的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep expgsql /var/log/messages</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="其它故障的处理"><a href="#其它故障的处理" class="headerlink" title="其它故障的处理"></a>其它故障的处理</h2><h3 id="无Master时的修复"><a href="#无Master时的修复" class="headerlink" title="无Master时的修复"></a>无Master时的修复</h3><p>如果切换失败或其它原因导致集群中没有Master，可以参考下面的步骤修复</p>
<h4 id="方法1：使用cleanup修复"><a href="#方法1：使用cleanup修复" class="headerlink" title="方法1：使用cleanup修复"></a>方法1：使用cleanup修复</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls_cleanup</span><br></pre></td></tr></table></figure>
<p>大部分情况，cleanup就可以找到Master。而且应该首先使用cleanup。如果不成功，再采用下面的方法</p>
<h4 id="方法2：人工修复复制关系"><a href="#方法2：人工修复复制关系" class="headerlink" title="方法2：人工修复复制关系"></a>方法2：人工修复复制关系</h4><ol>
<li><p>将资源脱离集群管理</p>
<p>cls_unmanage</p>
</li>
<li><p>人工修复PostgreSQL，建立复制关系<br>至于master的选取，可以选择<code>pgsql_REPL_INFO</code>中的master节点，或根据xlog位置确定。</p>
</li>
<li><p>在所有节点上停止PostgreSQL</p>
</li>
<li><p>清除状态并恢复集群管理</p>
<p>cls_manage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls_reset_master</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="方法3：快速恢复Master节点再恢复Slave"><a href="#方法3：快速恢复Master节点再恢复Slave" class="headerlink" title="方法3：快速恢复Master节点再恢复Slave"></a>方法3：快速恢复Master节点再恢复Slave</h4><p>可以明确指定将哪个节点作为Master，省略则通过xlog位置比较确定master</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cls_reset_master [master]</span><br></pre></td></tr></table></figure>
<h3 id="疑难的Pacemaker问题的处理"><a href="#疑难的Pacemaker问题的处理" class="headerlink" title="疑难的Pacemaker问题的处理"></a>疑难的Pacemaker问题的处理</h3><p>有时候可能会遇到一些顽固的问题，Pacemaker不按期望的动作，或某个资源处于错误状态却无法清除。<br>这时最简单的办法就是清除CIB重新设置。可执行下面的命令完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./setup.sh [master]</span><br></pre></td></tr></table></figure>
<p>如果不指定master，并且PostgreSQL进程是活动的，通过当前PostgreSQL进程的主备关系决定谁是master。<br>如果当前没有处于主的PostgreSQL进程，通过比较xlog位置确定谁作为master。</p>
<p>在PostgreSQL服务启动期间，正常情况下，执行setup.sh不会使服务停止。</p>
<p>setup.sh还可以完全取代前面的<code>cls_reset_master</code>。</p>
<h3 id="fail-count的清除"><a href="#fail-count的清除" class="headerlink" title="fail-count的清除"></a>fail-count的清除</h3><p>如果某个节点上有资源的fail-count不为0，最好将其清除，即使当前资源是健康的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cls_cleanup</span><br><span class="line">ps resource cleanup msPostgresql</span><br></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>./setup.sh会清除CIB，对Pacemaker资源定义的修改应该写到config.pcs里，防止下次执行setup.sh丢失。</li>
<li>有些包装后的脚本容易超时，比如<code>cls_rebuild_slave</code>。此时可能执行还没有完成的，需要通过<code>cls_status</code>或日志进行确认。</li>
</ol>
<h3 id="pg-log-和pg-xlog-和pg-clog的区别"><a href="#pg-log-和pg-xlog-和pg-clog的区别" class="headerlink" title="pg_log 和pg_xlog 和pg_clog的区别"></a>pg_log 和pg_xlog 和pg_clog的区别</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>pg_xlog</span><br><span class="line">这个日志是记录的Postgresql的WAL信息，也就是一些事务日志信息(transaction log)，默认单个大小是16M，源码安装的时候可以更改其大小。这些信息通常名字是类似'000000010000000000000013'这样的文件，这些日志会在定时回滚恢复(PITR)，流复制(Replication Stream)以及归档时能被用到，这些日志是非常重要的，记录着数据库发生的各种事务信息，不得随意删除或者移动这类日志文件，不然你的数据库会有无法恢复的风险</span><br><span class="line"></span><br><span class="line">当你的归档或者流复制发生异常的时候，事务日志会不断地生成，有可能会造成你的磁盘空间被塞满，最终导致DB挂掉或者起不来。遇到这种情况不用慌，可以先关闭归档或者流复制功能，备份pg_xlog日志到其他地方，但请不要删除。然后删除较早时间的的pg_xlog，有一定空间后再试着启动Postgres。</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>pg_clog</span><br><span class="line">pg_clog这个文件也是事务日志文件，但与pg_xlog不同的是它记录的是事务的元数据(metadata)，这个日志告诉我们哪些事务完成了，哪些没有完成。这个日志文件一般非常小，但是重要性也是相当高，不得随意删除或者对其更改信息。</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line"><span class="meta">#</span>pg_log记录各种Error信息，以及服务器与DB的状态信息，可由用户随意更新删除</span><br><span class="line"><span class="meta">#</span>pg_xlog与pg_clog记录数据库的事务信息，不得随意删除更新，做物理备份时要记得备份着两个日志。</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    
    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

      
    </div>
    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">
  <p><span>本文标题:</span><a href="/2018/05/31/postgressql/">postgres日常使用</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 ZHD 的个人博客">ZHD</a></p>
  <p><span>发布时间:</span>2018年05月31日 - 21:05</p>
  <p><span>最后更新:</span>2020年03月02日 - 16:03</p>
  <p><span>原始链接:</span><a href="/2018/05/31/postgressql/" title="postgres日常使用">http://yoursite.com/2018/05/31/postgressql/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://yoursite.com/2018/05/31/postgressql/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({   
          title: "",   
          text: '复制成功',   
          html: false,
          timer: 500,   
          showConfirmButton: false
        });
      });
    }));  
</script>

      
    </div>

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="ZHD 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="ZHD 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/postgres/" rel="tag"># postgres</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/27/ansible-command/" rel="next" title="ansible常用命令">
                <i class="fa fa-chevron-left"></i> ansible常用命令
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/31/corosync-pg/" rel="prev" title="corosync+ pacemaker实现pg流复制自动切换">
                corosync+ pacemaker实现pg流复制自动切换 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNjk4NS8xMzUyMQ=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="ZHD" />
            
              <p class="site-author-name" itemprop="name">ZHD</p>
              <p class="site-description motion-element" itemprop="description">盛年不重来，一日难再晨;及时当勉励，岁月不待人。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xingmengyoulan" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://weibo.com" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.uisdc.com/" title="优设" target="_blank">优设</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.alloyteam.com/nav/" title="Web前端导航" target="_blank">Web前端导航</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.36zhen.com/t?id=3448" title="前端书籍资料" target="_blank">前端书籍资料</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://ife.baidu.com/" title="百度前端技术学院" target="_blank">百度前端技术学院</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wf.uisdc.com/cn/" title="google前端开发基础" target="_blank">google前端开发基础</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#环境变量"><span class="nav-number">1.</span> <span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建数据库"><span class="nav-number">2.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#清除所有表"><span class="nav-number">3.</span> <span class="nav-text">清除所有表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查看表的索引："><span class="nav-number">4.</span> <span class="nav-text">查看表的索引：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导出备份数据库："><span class="nav-number">5.</span> <span class="nav-text">导出备份数据库：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导入恢复数据库-sql文件是pg-dump导出的文件就行，可以是整个数据库，也可以只是单个表，也可以只是结构等"><span class="nav-number">6.</span> <span class="nav-text">导入恢复数据库(sql文件是pg_dump导出的文件就行，可以是整个数据库，也可以只是单个表，也可以只是结构等)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导出数据结构，主要是加上参数-s："><span class="nav-number">7.</span> <span class="nav-text">导出数据结构，主要是加上参数-s：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导出某个表："><span class="nav-number">8.</span> <span class="nav-text">导出某个表：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导出某个表的结构，同样是加参数”-s”："><span class="nav-number">9.</span> <span class="nav-text">导出某个表的结构，同样是加参数”-s”：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导出某个表的数据，加参数”-a”："><span class="nav-number">10.</span> <span class="nav-text">导出某个表的数据，加参数”-a”：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#由于-copy-命令始终是到数据库服务端找文件，当以文件形式导入导出数据时需以超级用户执行，权限要求很高，适合数据库管理员操作-而-copy-命令可在客户端执行导入客户端的数据文件，权限要求没那么高，适合开发人员，测试人员使用，因为生产库的权限掌握在-DBA-手中。"><span class="nav-number">11.</span> <span class="nav-text">由于 copy 命令始终是到数据库服务端找文件，当以文件形式导入导出数据时需以超级用户执行，权限要求很高，适合数据库管理员操作;而 \copy 命令可在客户端执行导入客户端的数据文件，权限要求没那么高，适合开发人员，测试人员使用，因为生产库的权限掌握在 DBA 手中。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#清除所有表-1"><span class="nav-number">12.</span> <span class="nav-text">清除所有表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#获取系统表中字段信息"><span class="nav-number">13.</span> <span class="nav-text">获取系统表中字段信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#指定去重的列排序"><span class="nav-number">14.</span> <span class="nav-text">指定去重的列排序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建序列"><span class="nav-number">15.</span> <span class="nav-text">创建序列</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#锁表问题"><span class="nav-number">16.</span> <span class="nav-text">锁表问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#增删改查的操作"><span class="nav-number">17.</span> <span class="nav-text">增删改查的操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建索引"><span class="nav-number">18.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#时间的使用方法"><span class="nav-number">19.</span> <span class="nav-text">时间的使用方法:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如何找到postgreSQL数据库中占空间最大的表？"><span class="nav-number">20.</span> <span class="nav-text">如何找到postgreSQL数据库中占空间最大的表？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如何计算postgreSQL数据库所占用的硬盘大小？"><span class="nav-number">21.</span> <span class="nav-text">如何计算postgreSQL数据库所占用的硬盘大小？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如何计算postgreSQL表所占用的硬盘大小？"><span class="nav-number">22.</span> <span class="nav-text">如何计算postgreSQL表所占用的硬盘大小？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#类别一、-如果两张张表（导出表和目标表）的字段一致，并且希望插入全部数据，可以用这种方法："><span class="nav-number">23.</span> <span class="nav-text">类别一、 如果两张张表（导出表和目标表）的字段一致，并且希望插入全部数据，可以用这种方法：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#要将-articles-表插入到-newArticles-表中，则可以通过如下SQL语句实现："><span class="nav-number">24.</span> <span class="nav-text">要将 articles 表插入到 newArticles 表中，则可以通过如下SQL语句实现：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如果只希望导入指定字段，可以用这种方法："><span class="nav-number">25.</span> <span class="nav-text">如果只希望导入指定字段，可以用这种方法：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#generate-series函数应用"><span class="nav-number">26.</span> <span class="nav-text">generate_series函数应用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#批量添加数据"><span class="nav-number">27.</span> <span class="nav-text">批量添加数据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#锁的问题"><span class="nav-number"></span> <span class="nav-text">锁的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常用语句"><span class="nav-number"></span> <span class="nav-text">常用语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每分钟查询结果"><span class="nav-number"></span> <span class="nav-text">每分钟查询结果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建基础备份"><span class="nav-number"></span> <span class="nav-text">创建基础备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用pg-rewind命令同步新备库"><span class="nav-number"></span> <span class="nav-text">用pg_rewind命令同步新备库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高可用（pcs-corosync-postgres）修复旧Master"><span class="nav-number"></span> <span class="nav-text">高可用（pcs+corosync+postgres）修复旧Master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高可用（pcs-corosync-postgres）Slave上进程故障"><span class="nav-number"></span> <span class="nav-text">高可用（pcs+corosync+postgres）Slave上进程故障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修复Salve"><span class="nav-number"></span> <span class="nav-text">修复Salve</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误排查"><span class="nav-number"></span> <span class="nav-text">错误排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其它故障的处理"><span class="nav-number"></span> <span class="nav-text">其它故障的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#无Master时的修复"><span class="nav-number"></span> <span class="nav-text">无Master时的修复</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#方法1：使用cleanup修复"><span class="nav-number"></span> <span class="nav-text">方法1：使用cleanup修复</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方法2：人工修复复制关系"><span class="nav-number"></span> <span class="nav-text">方法2：人工修复复制关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方法3：快速恢复Master节点再恢复Slave"><span class="nav-number"></span> <span class="nav-text">方法3：快速恢复Master节点再恢复Slave</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#疑难的Pacemaker问题的处理"><span class="nav-number"></span> <span class="nav-text">疑难的Pacemaker问题的处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fail-count的清除"><span class="nav-number"></span> <span class="nav-text">fail-count的清除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-number"></span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pg-log-和pg-xlog-和pg-clog的区别"><span class="nav-number"></span> <span class="nav-text">pg_log 和pg_xlog 和pg_clog的区别</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZHD</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


  <span class="post-meta-divider">|</span>


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共48.5k字</span>
</div>












        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</html>
